# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

# Define a constant for the base image URL
BASE_DISTROLESS_IMAGE_URL = "nvcr.io/nvidia/distroless/"

BASE_IMAGE_URL = "nvcr.io/nvidia/osmo/"
IMAGE_TAG = ""

################
#  Workspace   #
################

# This needs to be defined before any other rules.
module(
    name = "osmo_workspace",
)

################
#  Repo Rules  #
################

http_archive = use_repo_rule("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

http_file = use_repo_rule("@bazel_tools//tools/build_defs/repo:http.bzl", "http_file")

################
# Bazelisk     #
################

http_file(
    name = "bazelisk_linux_amd64",
    executable = True,
    sha256 = "e1508323f347ad1465a887bc5d2bfb91cffc232d11e8e997b623227c6b32fb76",
    urls = ["https://github.com/bazelbuild/bazelisk/releases/download/v1.27.0/bazelisk-linux-amd64"],
)

http_file(
    name = "bazelisk_linux_arm64",
    executable = True,
    sha256 = "bb608519a440d45d10304eb684a73a2b6bb7699c5b0e5434361661b25f113a5d",
    urls = ["https://github.com/bazelbuild/bazelisk/releases/download/v1.27.0/bazelisk-linux-arm64"],
)

osmo_constants = use_repo_rule("//bzl:osmo_constants_repo.bzl", "osmo_constants")

osmo_constants(
    name = "osmo_constants",
    base_image_url = BASE_IMAGE_URL,
    image_tag = IMAGE_TAG,
)

################
#    Common    #
################

bazel_dep(name = "aspect_bazel_lib", version = "2.14.0")
bazel_dep(name = "platforms", version = "0.0.11")
bazel_dep(name = "rules_shell", version = "0.3.0")

################
#    Python    #
################

bazel_dep(name = "aspect_rules_py", version = "1.3.2")
bazel_dep(name = "rules_python", version = "1.5.1")

python = use_extension("@rules_python//python/extensions:python.bzl", "python")
python.toolchain(
    ignore_root_user_error = True,
    is_default = True,
    python_version = "3.10.18",
)

pip = use_extension("@rules_python//python/extensions:pip.bzl", "pip")

# MyPy
pip.parse(
    experimental_index_url = "https://pypi.org/simple/",
    extra_pip_args = [
        "--retries",
        "10",
        "--timeout",
        "30",
    ],
    hub_name = "osmo_mypy_deps",
    python_version = "3.10.18",
    requirements_lock = "//bzl/mypy:locked_requirements.txt",
)
use_repo(pip, "osmo_mypy_deps")

# Linting
pip.parse(
    experimental_index_url = "https://pypi.org/simple/",
    extra_pip_args = [
        "--retries",
        "10",
        "--timeout",
        "30",
    ],
    hub_name = "pylint_python_deps",
    python_version = "3.10.18",
    requirements_lock = "//bzl/linting:locked_requirements.txt",
)
use_repo(pip, "pylint_python_deps")

# Osmo Python Dependencies
pip.parse(
    experimental_index_url = "https://pypi.org/simple/",
    extra_pip_args = [
        "--retries",
        "10",
        "--timeout",
        "30",
    ],
    hub_name = "osmo_python_deps",
    python_version = "3.10.18",
    requirements_lock = "//src:locked_requirements.txt",
)
use_repo(pip, "osmo_python_deps")

# Testing Python Dependencies
pip.parse(
    experimental_index_url = "https://pypi.org/simple/",
    extra_pip_args = [
        "--retries",
        "10",
        "--timeout",
        "30",
    ],
    hub_name = "osmo_tests_python_deps",
    python_version = "3.10.18",
    requirements_lock = "//src/tests:locked_requirements.txt",
)
use_repo(pip, "osmo_tests_python_deps")

# Docs Python Dependencies
pip.parse(
    experimental_index_url = "https://urm.nvidia.com/artifactory/api/pypi/pypi-remote/simple/",
    extra_pip_args = [
        "--retries",
        "10",
        "--timeout",
        "30",
    ],
    hub_name = "osmo_docs_deps",
    python_version = "3.10.18",
    requirements_lock = "//docs:locked_requirements.txt",
)
use_repo(pip, "osmo_docs_deps")

################
#     MyPy     #
################

bazel_dep(name = "rules_mypy", version = "0.38.0")

types = use_extension("@rules_mypy//mypy:types.bzl", "types")
types.requirements(
    name = "pip_types",
    pip_requirements = "@osmo_python_deps//:requirements.bzl",
    requirements_txt = "//src:locked_requirements.txt",
)
use_repo(types, "pip_types")

#############################
#     Formatter/Linting     #
#############################

# TODO: Re-enable when rules_diff@1.0.0 502 error from gitlab.arm.com is fixed
# bazel_dep(name = "aspect_rules_lint", version = "1.5.1")  # Temporarily disabled due to rules_diff@1.0.0 502 error from gitlab.arm.com

################
# Bazel Skylib #
################

bazel_dep(name = "bazel_skylib", version = "1.7.1")

################
#      Go      #
################

bazel_dep(name = "rules_go", version = "0.54.0", repo_name = "io_bazel_rules_go")
bazel_dep(name = "gazelle", version = "0.42.0", repo_name = "bazel_gazelle")

go_sdk = use_extension("@io_bazel_rules_go//go:extensions.bzl", "go_sdk")
go_sdk.from_file(
    go_mod = "//src/runtime:go.mod",
)

go_deps = use_extension("@bazel_gazelle//:extensions.bzl", "go_deps")
go_deps.from_file(go_mod = "//src/runtime:go.mod")

# Additional dependencies for building rsync for CLI distribution
go_deps.module(
    path = "github.com/BurntSushi/toml",
    sum = "h1:kuoIxZQy2WRRk1pttg9asf+WVv6tWQuBNVmK8+nqPr0=",
    version = "v1.4.0",
)
go_deps.module(
    path = "github.com/coreos/go-systemd",
    sum = "h1:iW4rZ826su+pqaw19uhpSCzhj44qo35pNgKFGqzDKkU=",
    version = "v0.0.0-20191104093116-d3cd4ed1dbcf",
)
go_deps.module(
    path = "golang.org/x/crypto",
    sum = "h1:kJNSjF/Xp7kU0iB2Z+9viTPMW4EqqsrywMXLJOOsXSE=",
    version = "v0.37.0",
)
use_repo(
    go_deps,
    "com_github_conduitio_bwlimit",
    "com_github_creack_pty",
    "com_github_gokrazy_rsync",
    "com_github_google_shlex",
    "com_github_gorilla_websocket",
    "in_gopkg_yaml_v3",

    # Dependencies for building rsync for CLI distribution
    "com_github_burntsushi_toml",
    "com_github_coreos_go_systemd",
    "org_golang_x_crypto",
)

################
# Rules Docker #
################

http_archive(
    name = "io_bazel_rules_docker",
    sha256 = "b1e80761a8a8243d03ebca8845e9cc1ba6c82ce7c5179ce2b295cd36f7e394bf",
    url = "https://github.com/bazelbuild/rules_docker/releases/download/v0.25.0/rules_docker-v0.25.0.tar.gz",
)

################
#     OCI      #
################

bazel_dep(name = "rules_oci", version = "2.2.3")
bazel_dep(name = "rules_distroless", version = "0.5.1")

oci = use_extension("@rules_oci//oci:extensions.bzl", "oci")

# Configure distroless apt packages
apt = use_extension("@rules_distroless//apt:extensions.bzl", "apt")
apt.install(
    name = "debian_packages",
    lock = "//bzl/debian_packages:debian_packages.lock.json",
    manifest = "//bzl/debian_packages:debian_packages.yaml",
)
apt.install(
    name = "debian_packages_arm64",
    lock = "//bzl/debian_packages:debian_packages_arm64.lock.json",
    manifest = "//bzl/debian_packages:debian_packages_arm64.yaml",
)
apt.install(
    name = "dev_builder_debian_packages_x86_64",
    lock = "//bzl/debian_packages:dev_builder_debian_packages_x86_64.lock.json",
    manifest = "//bzl/debian_packages:dev_builder_debian_packages_x86_64.yaml",
)
apt.install(
    name = "dev_builder_debian_packages_arm64",
    lock = "//bzl/debian_packages:dev_builder_debian_packages_arm64.lock.json",
    manifest = "//bzl/debian_packages:dev_builder_debian_packages_arm64.yaml",
)

oci.pull(
    name = "distroless_python3_10",
    digest = "sha256:0a7579c79349e7c3e232bac7afc09348ecb0bc7e651607067f9d44b3e3dbd20c",
    image = BASE_DISTROLESS_IMAGE_URL + "python:3.10-v3.4.15",
    platforms = [
        "linux/arm64/v8",
        "linux/amd64",
    ],
)

# Used for local debugging
# oci.pull(
#     name = "distroless_python3_10_dev",
#     image = BASE_DISTROLESS_IMAGE_URL + "python:3.10-v3.4.15-dev",
#     platforms = [
#          "linux/amd64",
#          "linux/arm64/v8"
#     ],
#     digest = "sha256:314c96285c3e60d5d6fb045d14a30f5828ae62d44fb0739aa0fd792b033df369",
# )

oci.pull(
    name = "ubuntu_22_04",
    digest = "sha256:be0d0eb70eb824666ab98a76ad74780fe1a68e3a9390efea9268c56e5a531226",
    image = "nvcr.io/nvidia/base/ubuntu:jammy-20250619",
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ],
)
oci.pull(
    name = "node_22_distroless",
    digest = "sha256:53be04b7e9c3fae6af567e006efd1e36ccc37eacf5c4e879ae2823d4f1fd8c97",
    image = BASE_DISTROLESS_IMAGE_URL + "node:22-v3.0.18",
    platforms = [
        "linux/amd64",
        "linux/arm64/v8",
    ],
)
use_repo(
    oci,
    "distroless_python3_10",
    "distroless_python3_10_linux_amd64",
    "distroless_python3_10_linux_arm64_v8",
    # "distroless_python3_10_dev",
    # "distroless_python3_10_dev_linux_amd64",
    # "distroless_python3_10_dev_linux_arm64_v8",
    "node_22_distroless",
    "node_22_distroless_linux_amd64",
    "node_22_distroless_linux_arm64_v8",
    "ubuntu_22_04",
    "ubuntu_22_04_linux_amd64",
    "ubuntu_22_04_linux_arm64",
)

use_repo(
    apt,
    "debian_packages",
    "debian_packages_arm64",
    "dev_builder_debian_packages_arm64",
    "dev_builder_debian_packages_x86_64",
)

################
#  Packaging   #
################

bazel_dep(name = "rules_pkg", version = "1.1.0")

####################
#  Python Library  #
####################

wheel_requires = use_repo_rule("//src/lib/distribution:requires.bzl", "wheel_requires_repo")

wheel_requires(
    name = "osmo_wheel_requires",
    requirements_txt = "//src:requirements.txt",
)

################
#  JavaScript  #
################

bazel_dep(name = "aspect_rules_js", version = "2.3.5")

# pnpm (https://pnpm.io/)
# Replaces `npm import`
# bazel run -- @pnpm//:pnpm --dir $PWD import
pnpm = use_extension("@aspect_rules_js//npm:extensions.bzl", "pnpm")
use_repo(pnpm, "pnpm")

# Node.js
bazel_dep(name = "rules_nodejs", version = "6.5.0")

node = use_extension("@rules_nodejs//nodejs:extensions.bzl", "node")
use_repo(node, "nodejs_linux_amd64")
use_repo(node, "nodejs_linux_arm64")
use_repo(node, "nodejs_darwin_arm64")
node.toolchain(node_version = "22.17.1")

# npm
npm = use_extension("@aspect_rules_js//npm:extensions.bzl", "npm")
npm.npm_translate_lock(
    name = "npm",
    data = [
        "//ui:package.json",
        "//ui:pnpm-lock.yaml",
    ],
    npm_package_lock = "//ui:package-lock.json",
    npmrc = "//ui:.npmrc",
    pnpm_lock = "//ui:pnpm-lock.yaml",
    update_pnpm_lock = False,
    verify_node_modules_ignored = "//:.bazelignore",
)
use_repo(npm, "npm")
