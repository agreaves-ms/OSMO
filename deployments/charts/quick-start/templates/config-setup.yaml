# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Namespace }}-config-setup
spec:
  ttlSecondsAfterFinished: 30
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-ingress
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z quick-start 80; do
            echo "Waiting for quick-start..."
            sleep 2
          done
          echo "OSMO quick start ingress is ready"
      containers:
      - name: config-setup
        image: alpine/curl:8.14.1
        command:
        - /bin/sh
        - -c
        - |
          set -e

          apk add --no-cache jq

          BASE_URL="http://quick-start.osmo"
          echo "Using URL: $BASE_URL"

          echo "Configuring OSMO settings..."

          echo "Configuring OSMO workflow settings..."

          echo "Debug - Container Registry Variables:"
          echo "CONTAINER_REGISTRY: ${CONTAINER_REGISTRY}"
          echo "Making PATCH request to /api/configs/workflow..."
          response=$(curl  --max-time 30 --retry 3 --retry-delay 5 \
            --fail-with-body \
            -w "HTTP_STATUS:%{http_code}" \
            -X PATCH \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/configs/workflow" \
            -d '{
              "configs_dict": {
                "workflow_data": {
                  "credential": {
                    "endpoint": "'"${OBJECT_STORAGE_ENDPOINT}"'/workflows",
                    "access_key_id": "'"${OBJECT_STORAGE_ACCESS_KEY_ID}"'",
                    "access_key": "'"${OBJECT_STORAGE_ACCESS_KEY}"'",
                    "region": "'"${OBJECT_STORAGE_REGION}"'"
                  }
                },
                "workflow_log": {
                  "credential": {
                    "endpoint": "'"${OBJECT_STORAGE_ENDPOINT}"'/workflows",
                    "access_key_id": "'"${OBJECT_STORAGE_ACCESS_KEY_ID}"'",
                    "access_key": "'"${OBJECT_STORAGE_ACCESS_KEY}"'",
                    "region": "'"${OBJECT_STORAGE_REGION}"'"
                  }
                },
                "workflow_app": {
                  "credential": {
                    "endpoint": "'"${OBJECT_STORAGE_ENDPOINT}"'/apps",
                    "access_key_id": "'"${OBJECT_STORAGE_ACCESS_KEY_ID}"'",
                    "access_key": "'"${OBJECT_STORAGE_ACCESS_KEY}"'",
                    "region": "'"${OBJECT_STORAGE_REGION}"'"
                  }
                },
                "backend_images": {
                  "init": "'"${OSMO_IMAGE_LOCATION}"'/init-container:'"${OSMO_IMAGE_TAG}"'",
                  "client": "'"${OSMO_IMAGE_LOCATION}"'/client:'"${OSMO_IMAGE_TAG}"'"'"$(
                    if [ -n "${CONTAINER_REGISTRY}" ] && \
                       [ -n "${CONTAINER_REGISTRY_USERNAME}" ] && \
                       [ -n "${CONTAINER_REGISTRY_PASSWORD}" ]; then
                      echo ',
                  "credential": {
                    "registry": "'"${CONTAINER_REGISTRY}"'",
                    "username": "'"${CONTAINER_REGISTRY_USERNAME}"'",
                    "auth": "'"${CONTAINER_REGISTRY_PASSWORD}"'"
                  }'
                    fi
                  )"'
                },
                "credential_config": {
                  "disable_data_validation": ["s3"]
                }
              },
              "description": "Set up workflow config for local development"
            }')

          # Check response
          http_code=$(echo "$response" | grep -o 'HTTP_STATUS:[0-9]*' | cut -d: -f2)
          body=$(echo "$response" | sed 's/HTTP_STATUS:[0-9]*$//')

          echo "Workflow config response code: $http_code"
          if [ "$http_code" -ge 400 ]; then
            echo "ERROR: Workflow config failed with status $http_code"
            echo "Response body: $body"
            exit 1
          else
            echo "Workflow config successful"
          fi

          echo "Configuring pod templates..."

          # Update pod template configuration (PUT /api/configs/pod_template)
          curl -s -X PUT \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/configs/pod_template" \
            -d '{
              "configs": {
                "default_compute": {
                  "spec": {
                    "containers": [
                      {
                        "name": "{{ "{{USER_CONTAINER_NAME}}" }}",
                        "env": [
                          {
                            "name": "AWS_ENDPOINT_URL_S3",
                            "value": "'"${AWS_ENDPOINT_URL_S3}"'"
                          },
                          {
                            "name": "AWS_S3_FORCE_PATH_STYLE",
                            "value": "true"
                          },
                          {
                            "name": "AWS_DEFAULT_REGION",
                            "value": "'"${OBJECT_STORAGE_REGION}"'"
                          },
                          {
                            "name": "OSMO_LOGIN_DEV",
                            "value": "true"
                          },
                          {
                            "name": "OSMO_SKIP_DATA_AUTH",
                            "value": "1"
                          }
                        ]
                      },
                      {
                        "name": "osmo-ctrl",
                        "env": [
                          {
                            "name": "AWS_ENDPOINT_URL_S3",
                            "value": "'"${AWS_ENDPOINT_URL_S3}"'"
                          },
                          {
                            "name": "AWS_S3_FORCE_PATH_STYLE",
                            "value": "true"
                          },
                          {
                            "name": "AWS_DEFAULT_REGION",
                            "value": "'"${OBJECT_STORAGE_REGION}"'"
                          },
                          {
                            "name": "OSMO_LOGIN_DEV",
                            "value": "true"
                          },
                          {
                            "name": "OSMO_SKIP_DATA_AUTH",
                            "value": "1"
                          }
                        ]
                      }
                    ],
                    "nodeSelector": {
                      "node_group": "compute"
                    }
                  }
                }
              },
              "description": "Add compute pod template"
            }'

          # Update pool with compute template (PATCH /api/configs/pool/default)
          curl -s -X PATCH \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/configs/pool/default" \
            -d '{
              "configs_dict": {
                "common_pod_template": [
                  "default_ctrl",
                  "default_user",
                  "default_compute"
                ]
              },
              "description": "Add compute pod template"
            }'

          echo "Configuring dataset settings..."

          # Update dataset configuration (PATCH /api/configs/dataset)
          curl -s -X PATCH \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/configs/dataset" \
            -d '{
              "configs_dict": {
                "buckets": {
                  "osmo": {
                    "dataset_path": "'"${OBJECT_STORAGE_ENDPOINT}"'/datasets"
                  }
                },
                "default_bucket": "osmo"
              },
              "description": "Add dataset bucket"
            }'

          echo "Configuring service settings..."

          # Update service configuration (PATCH /api/configs/service)
          curl -s -X PATCH \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/configs/service" \
            -d '{
              "configs_dict": {
                "service_base_url": "'"$BASE_URL"'"
              },
              "description": "Update service base url"
            }'

          echo "Waiting for backend default to exist..."
          until curl -s -f "$BASE_URL/api/configs/backend/default" > /dev/null 2>&1; do
            echo "Backend default not ready yet, waiting..."
            sleep 5
          done
          echo "Backend default is now available"

          echo "Configuring backend settings..."

          # Update backend configuration (POST /api/configs/backend/default)
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/configs/backend/default" \
            -d '{
              "configs": {
                "router_address": "ws://quick-start.osmo"
              },
              "description": "Update default backend config"
            }'

          echo "Setting default pool..."

          # Set default pool (POST /api/profile/settings)
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/profile/settings" \
            -d '{
              "pool": "default"
            }'

          echo "Setting data credential..."

          # Set data credential (POST /api/credentials/osmo)
          curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "x-osmo-user: testuser" \
            "$BASE_URL/api/credentials/osmo" \
            -d '{
              "data_credential": {
                "access_key_id": "'"${OBJECT_STORAGE_ACCESS_KEY_ID}"'",
                "access_key": "'"${OBJECT_STORAGE_ACCESS_KEY}"'",
                "endpoint": "'"${OBJECT_STORAGE_ENDPOINT}"'",
                "region": "'"${OBJECT_STORAGE_REGION}"'"
              }
            }'

          echo "OSMO configuration completed successfully!"
        env:
        - name: AWS_ENDPOINT_URL_S3
          value: {{ .Values.global.objectStorage.awsEndpointUrlS3 | quote }}
        - name: OBJECT_STORAGE_ENDPOINT
          value: {{ .Values.global.objectStorage.endpoint | quote }}
        - name: OBJECT_STORAGE_ACCESS_KEY_ID
          value: {{ .Values.global.objectStorage.accessKeyId | quote }}
        - name: OBJECT_STORAGE_ACCESS_KEY
          value: {{ .Values.global.objectStorage.accessKey | quote }}
        - name: OBJECT_STORAGE_REGION
          value: {{ .Values.global.objectStorage.region | quote }}
        - name: CONTAINER_REGISTRY
          value: {{ .Values.global.containerRegistry.registry | quote }}
        - name: CONTAINER_REGISTRY_USERNAME
          value: {{ .Values.global.containerRegistry.username | quote }}
        - name: CONTAINER_REGISTRY_PASSWORD
          value: {{ .Values.global.containerRegistry.password | quote }}
        - name: OSMO_IMAGE_LOCATION
          value: {{ .Values.global.osmoImageLocation | quote }}
        - name: OSMO_IMAGE_TAG
          value: {{ .Values.global.osmoImageTag | quote }}

