# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

## Global configuration values shared across all OSMO services
##
global:
  ## Base location for OSMO Docker images in the registry
  ##
  osmoImageLocation: nvcr.io/nvidia/osmo

  ## Docker image tag for OSMO services
  ##
  osmoImageTag: latest

  ## Node selector constraints for pod scheduling
  ##
  nodeSelector:
    ## Schedule pods only on service nodes
    ##
    node_group: service

  ## Name of the Kubernetes secret containing Docker registry credentials
  ##
  imagePullSecret: null

  ## Container registry configuration for OSMO images
  ##
  ## TODO: Remove credentials once we can use public registry
  ##
  containerRegistry:
    ## Container registry URL
    ##
    registry: nvcr.io
    ## Container registry username (OAuth token for NGC)
    ##
    username: $oauthtoken
    ## Container registry password (NGC API key)
    ##
    password: ""

  ## Object storage configuration for workflow data storage
  ##
  objectStorage:
    ## Object storage endpoint URL for workflow logs, datasets, and other data
    ##
    endpoint: "s3://osmo"
    ## Object storage access key ID for authentication
    ##
    accessKeyId: "test"
    ## Object storage access key for authentication
    ##
    accessKey: "test"
    ## Object storage region where the bucket is located
    ##
    region: "us-east-1"
    ## AWS endpoint URL
    ##
    ## Changed for localstack-s3
    ##
    awsEndpointUrlS3: "http://localstack-s3.osmo:4566"

## Ingress NGINX Controller configuration
##
ingress-nginx:
  ## Override the full name of the ingress-nginx resources
  ##
  fullnameOverride: quick-start
  ## Controller configuration for traffic routing
  ##
  controller:
    ## Set controller name to empty string to remove the -controller suffix
    ##
    name: ""
    ## Node selector constraints for ingress controller pod scheduling
    ##
    nodeSelector:
      ## Schedule ingress controller on service nodes
      ##
      node_group: ingress
    ## Service configuration for ingress controller
    ##
    service:
      ## Service type for ingress controller (NodePort for local access)
      ##
      type: NodePort
      ## NodePort configuration for external access
      ##
      nodePorts:
        ## HTTP port for external access to ingress controller
        ##
        http: 30080
    ## Init containers for ingress controller
    ##
    ## Wait for the web UI to be up before starting ingress controller
    ##
    extraInitContainers:
    - name: wait-for-web-ui
      image: busybox:1.37.0
      command:
      - sh
      - -c
      - |
        until nc -z osmo-ui 80; do
          echo "Waiting for web-ui..."
          sleep 2
        done
        echo "Web UI is ready"

## OSMO main service configuration
##
service:
  ## Configuration for individual OSMO services
  ##
  services:
    ## Configuration file service settings
    ##
    configFile:
      ## Enable external configuration file loading (MEK configuration)
      ##
      enabled: true
      ## Path to the Master Encryption Key (MEK) configuration file
      ##
      path: /home/osmo/config/mek.yaml

    ## PostgreSQL database service configuration
    ##
    postgres:
      ## Enable PostgreSQL deployment on Kubernetes
      ##
      enabled: true
      ## Kubernetes image pull policy for PostgreSQL
      ##
      imagePullPolicy: IfNotPresent
      ## Storage class name for persistent volume
      ##
      storageClassName: standard
      ## PostgreSQL password
      ##
      password: "osmo"
      ## Node selector constraints for pod scheduling
      ##
      nodeSelector:
        ## Schedule pods only on data nodes
        ##
        node_group: data

    ## Redis cache service configuration
    ##
    redis:
      ## Enable Redis deployment on Kubernetes
      ##
      enabled: true
      ## Kubernetes image pull policy for Redis
      ##
      imagePullPolicy: IfNotPresent
      ## Storage class name for persistent volume
      ##
      storageClassName: standard
      ## Enable TLS encryption for Redis connections
      ##
      tlsEnabled: false
      ## Node selector constraints for pod scheduling
      ##
      nodeSelector:
        ## Schedule pods only on data nodes
        ##
        node_group: data

    ## Localstack S3 Object storage configuration
    ##
    localstackS3:
      ## Enable Localstack S3 Object storage deployment on Kubernetes
      ##
      enabled: true
      ## Kubernetes image pull policy for Localstack S3
      ##
      imagePullPolicy: IfNotPresent
      ## Buckets for the Localstack S3 Object storage
      ##
      buckets: ["osmo"]
      ## Persistent volume configuration for Localstack S3 Object storage
      ##
      persistence:
        enabled: true
        hostPath: /var/lib/localstack
      ## Node selector constraints for pod scheduling
      ##
      nodeSelector:
        ## Schedule pods only on data nodes
        ##
        node_group: data

    ## Main API service configuration
    ##
    service:
      ## Hostname for the OSMO service ingress
      ##
      hostname: quick-start.osmo
      ## Kubernetes image pull policy for the API service
      ##
      imagePullPolicy: IfNotPresent
      ## Horizontal Pod Autoscaler (HPA) configuration for the API service
      ##
      scaling:
        ## Minimum number of API service replicas
        ##
        minReplicas: 1
        ## Maximum number of API service replicas
        ##
        maxReplicas: 1
      ## Ingress configuration for external access to the API service
      ##
      ingress:
        ## Enable SSL/TLS encryption for the ingress
        ##
        sslEnabled: false
      ## Init containers for API service
      ##
      ## Wait for data infra to be up before starting service
      ##
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z postgres 5432; do
            echo "Waiting for postgres..."
            sleep 2
          done
          echo "Postgres is ready"
      - name: wait-for-redis
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z redis 6379; do
            echo "Waiting for redis..."
            sleep 2
          done
          echo "Redis is ready"
      - name: wait-for-localstack-s3
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z localstack-s3 4566; do
            echo "Waiting for localstack-s3..."
            sleep 2
          done
          echo "Localstack S3 is ready"
      ## Additional environment variables for the API service
      ##
      extraEnv:
      - name: AWS_ENDPOINT_URL_S3
        value: http://localstack-s3.osmo:4566
      - name: AWS_S3_FORCE_PATH_STYLE
        value: "true"
      - name: AWS_DEFAULT_REGION
        value: us-east-1
      - name: OSMO_SKIP_DATA_AUTH
        value: "1"

    ## Worker service configuration for background job processing
    ##
    worker:
      ## Kubernetes image pull policy for the worker service
      ##
      imagePullPolicy: IfNotPresent
      ## Horizontal Pod Autoscaler (HPA) configuration for workers
      ##
      scaling:
        ## Minimum number of worker replicas
        ##
        minReplicas: 1
        ## Maximum number of worker replicas
        ##
        maxReplicas: 1
      ## Init containers for worker service
      ##
      ## Wait for data infra to be up before starting service
      ##
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z postgres 5432; do
            echo "Waiting for postgres..."
            sleep 2
          done
          echo "Postgres is ready"
      - name: wait-for-redis
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z redis 6379; do
            echo "Waiting for redis..."
            sleep 2
          done
          echo "Redis is ready"
      - name: wait-for-localstack-s3
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z localstack-s3 4566; do
            echo "Waiting for localstack-s3..."
            sleep 2
          done
          echo "Localstack S3 is ready"
      ## Additional environment variables for the worker service
      ##
      extraEnv:
      - name: AWS_ENDPOINT_URL_S3
        value: http://localstack-s3.osmo:4566
      - name: AWS_S3_FORCE_PATH_STYLE
        value: "true"
      - name: AWS_DEFAULT_REGION
        value: us-east-1

    ## Logger service configuration for log collection and processing
    ##
    logger:
      ## Kubernetes image pull policy for the logger service
      ##
      imagePullPolicy: IfNotPresent
      ## Horizontal Pod Autoscaler (HPA) configuration for the logger service
      ##
      scaling:
        ## Minimum number of logger service replicas
        ##
        minReplicas: 1
        ## Maximum number of logger service replicas
        ##
        maxReplicas: 1
      ## Init containers for logger service
      ##
      ## Wait for data infra to be up before starting service
      ##
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z postgres 5432; do
            echo "Waiting for postgres..."
            sleep 2
          done
          echo "Postgres is ready"
      - name: wait-for-redis
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z redis 6379; do
            echo "Waiting for redis..."
            sleep 2
          done
          echo "Redis is ready"
      - name: wait-for-localstack-s3
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z localstack-s3 4566; do
            echo "Waiting for localstack-s3..."
            sleep 2
          done
          echo "Localstack S3 is ready"
      ## Additional environment variables for the logger service
      ##
      extraEnv:
      - name: AWS_ENDPOINT_URL_S3
        value: http://localstack-s3.osmo:4566
      - name: AWS_S3_FORCE_PATH_STYLE
        value: "true"
      - name: AWS_DEFAULT_REGION
        value: us-east-1

    ## Agent service configuration for client communication and management
    ##
    agent:
      ## Kubernetes image pull policy for the agent service
      ##
      imagePullPolicy: IfNotPresent
      ## Horizontal Pod Autoscaler (HPA) configuration for the agent service
      ##
      scaling:
        ## Minimum number of agent service replicas
        ##
        minReplicas: 1
        ## Maximum number of agent service replicas
        ##
        maxReplicas: 1
      ## Init containers for agent service
      ##
      ## Wait for data infra to be up before starting service
      ##
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z postgres 5432; do
            echo "Waiting for postgres..."
            sleep 2
          done
          echo "Postgres is ready"
      - name: wait-for-redis
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z redis 6379; do
            echo "Waiting for redis..."
            sleep 2
          done
          echo "Redis is ready"
      - name: wait-for-localstack-s3
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z localstack-s3 4566; do
            echo "Waiting for localstack-s3..."
            sleep 2
          done
          echo "Localstack S3 is ready"
      ## Additional environment variables for the agent service
      ##
      extraEnv:
      - name: AWS_ENDPOINT_URL_S3
        value: http://localstack-s3.osmo:4566
      - name: AWS_S3_FORCE_PATH_STYLE
        value: "true"
      - name: AWS_DEFAULT_REGION
        value: us-east-1

    ## Delayed job monitor service configuration
    ##
    delayedJobMonitor:
      ## Kubernetes image pull policy for the delayed job monitor service
      ##
      imagePullPolicy: IfNotPresent
      ## Init containers for delayed job monitor service
      ##
      ## Wait for data infra to be up before starting service
      ##
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z postgres 5432; do
            echo "Waiting for postgres..."
            sleep 2
          done
          echo "Postgres is ready"
      - name: wait-for-redis
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z redis 6379; do
            echo "Waiting for redis..."
            sleep 2
          done
          echo "Redis is ready"
      - name: wait-for-localstack-s3
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z localstack-s3 4566; do
            echo "Waiting for localstack-s3..."
            sleep 2
          done
          echo "Localstack S3 is ready"

  ## Configuration for service sidecar containers
  ##
  sidecars:
    ## Envoy proxy sidecar configuration
    ##
    envoy:
      ## Enable Envoy proxy sidecar container
      ##
      enabled: false
    ## Log agent sidecar configuration
    ##
    logAgent:
      ## Enable log agent sidecar for centralized log collection
      ##
      enabled: false
      ## Log rotation configuration
      ##
      logrotate:
        ## Enable automatic log rotation
        ##
        enabled: false
    ## OpenTelemetry (OTEL) sidecar configuration
    ##
    otel:
      ## Enable OTEL collector sidecar for metrics and tracing
      ##
      enabled: false
    ## Rate limiting sidecar configuration
    ##
    rateLimit:
      ## Enable rate limiting service
      ##
      enabled: false

## Web UI service configuration
##
web-ui:
  ## Configuration for web UI services
  ##
  services:
    ## Main UI service configuration
    ##
    ui:
      ## Init containers for UI service
      ##
      ## Wait for the API service to be up before starting the UI
      ##
      initContainers:
      - name: wait-for-service
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z osmo-service 80; do
            echo "Waiting for osmo-service..."
            sleep 2
          done
          echo "OSMO service is ready"
      ## Skip authentication for UI service
      ##
      skipAuth: true
      ## Hostname for the UI service ingress
      ##
      hostname: quick-start.osmo
      ## Ingress configuration for external access to the UI service
      ##
      ingress:
        ## Enable SSL/TLS encryption for the ingress
        ##
        sslEnabled: false

  ## Configuration for web UI sidecar containers
  ##
  sidecars:
    ## Envoy proxy sidecar configuration
    ##
    envoy:
      ## Enable Envoy proxy sidecar container
      ##
      enabled: false

## Router service configuration
##
router:
  ## Configuration for router services
  ##
  services:
    ## Configuration file service settings
    ##
    configFile:
      ## Enable external configuration file loading (MEK configuration)
      ##
      enabled: true
      ## Path to the Master Encryption Key (MEK) configuration file
      ##
      path: /home/osmo/config/mek.yaml

    ## Main router service configuration
    ##
    service:
      ## Hostname for the router service ingress
      ##
      hostname: quick-start.osmo
      ## Kubernetes image pull policy for the router service
      ##
      imagePullPolicy: IfNotPresent
      ## Horizontal Pod Autoscaler (HPA) configuration for the router service
      ##
      scaling:
        ## Minimum number of router service replicas
        ##
        minReplicas: 1
        ## Maximum number of router service replicas
        ##
        maxReplicas: 1
      ## Ingress configuration for external access to the router service
      ##
      ingress:
        ## Enable SSL/TLS encryption for the ingress
        ##
        sslEnabled: false
      ## Init containers for router service
      ##
      ## Wait for data infra to be up before starting service
      ##
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z postgres 5432; do
            echo "Waiting for postgres..."
            sleep 2
          done
          echo "Postgres is ready"
      - name: wait-for-redis
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z redis 6379; do
            echo "Waiting for redis..."
            sleep 2
          done
          echo "Redis is ready"

    ## PostgreSQL database service configuration
    ##
    postgres:
      ## PostgreSQL password
      ##
      password: "osmo"

  ## Configuration for router service sidecar containers
  ##
  sidecars:
    ## Envoy proxy sidecar configuration
    ##
    envoy:
      ## Enable Envoy proxy sidecar container
      ##
      enabled: false
    ## Log agent sidecar configuration
    ##
    logAgent:
      ## Enable log agent sidecar for centralized log collection
      ##
      enabled: false

## Backend operator configuration for managing compute workloads
##
backend-operator:
  ## Global configuration for backend operator
  ##
  global:
    ## OSMO service URL for backend operator communication
    ##
    serviceUrl: http://quick-start.osmo
    ## Kubernetes namespace for backend operator
    ##
    agentNamespace: osmo
    ## Kubernetes namespace for backend workloads
    ##
    backendNamespace: default
    ## Kubernetes namespace for backend test workloads
    ##
    backendTestNamespace: osmo-test
    ## Backend name identifier
    ##
    backendName: default
    ## Secret name containing backend operator authentication token
    ##
    accountTokenSecret: backend-operator-token
    ## Authentication method for backend operator
    ##
    loginMethod: token

  ## Configuration for backend operator services
  ##
  services:
    ## Backend listener service configuration
    ##
    backendListener:
      ## Kubernetes image pull policy for the backend listener service
      ##
      imagePullPolicy: IfNotPresent
      ## Init containers for backend listener service
      ##
      ## Wait for the agent service to be up before starting backend listener
      ##
      initContainers:
      - name: wait-for-ingress
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z quick-start 80; do
            echo "Waiting for quick-start..."
            sleep 2
          done
          echo "OSMO quick start ingress is ready"
      - name: wait-for-token
        image: alpine:3.18
        command:
        - sh
        - -c
        - |
          apk add --no-cache curl jq
          echo "Waiting for backend-operator-token to be created..."
          until curl -s http://quick-start.osmo/api/auth/access_token/service | jq -e '.[] | select(.token_name == "backend-operator-token")' >/dev/null 2>&1; do
            echo "Token backend-operator-token not found, waiting..."
            sleep 2
          done
          echo "Backend operator token is ready"
      ## Resource limits and requests for the backend listener container
      ##
      resources:
        ## Resource requests (guaranteed allocation)
        ##
        requests:
          cpu: "125m"
          memory: "128Mi"
        ## Resource limits (maximum allocation)
        ##
        limits:
          cpu: "250m"
          memory: "256Mi"
    ## Backend worker service configuration
    ##
    backendWorker:
      ## Kubernetes image pull policy for the backend worker service
      ##
      imagePullPolicy: IfNotPresent
      ## Init containers for backend worker service
      ##
      ## Wait for the agent service to be up before starting backend worker
      ##
      initContainers:
      - name: wait-for-ingress
        image: busybox:1.37.0
        command:
        - sh
        - -c
        - |
          until nc -z quick-start 80; do
            echo "Waiting for quick-start..."
            sleep 2
          done
          echo "OSMO quick start ingress is ready"
      - name: wait-for-token
        image: alpine:3.18
        command:
        - sh
        - -c
        - |
          apk add --no-cache curl jq
          echo "Waiting for backend-operator-token to be created..."
          until curl -s http://quick-start.osmo/api/auth/access_token/service | jq -e '.[] | select(.token_name == "backend-operator-token")' >/dev/null 2>&1; do
            echo "Token backend-operator-token not found, waiting..."
            sleep 2
          done
          echo "Backend operator token is ready"
      ## Resource limits and requests for the backend worker container
      ##
      resources:
        ## Resource requests (guaranteed allocation)
        ##
        requests:
          cpu: "125m"
          memory: "128Mi"
        ## Resource limits (maximum allocation)
        ##
        limits:
          cpu: "250m"
          memory: "256Mi"

  ## Backend test runner configuration
  ##
  backendTestRunner:
    ## Enable backend test runner
    ##
    enabled: false

  ## Configuration for backend operator sidecar containers
  ##
  sidecars:
    ## OpenTelemetry (OTEL) sidecar configuration
    ##
    OTEL:
      ## Enable OTEL collector sidecar for metrics and tracing
      ##
      enabled: false

