# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
## Global configuration values shared across all Osmo services
##
global:
  ## Base location for Osmo Docker images in the registry
  ##
  osmoImageLocation: nvcr.io/nvidia/osmo

  ## Docker image tag for Osmo services
  ##
  osmoImageTag: latest

  ## Name of the Kubernetes secret containing Docker registry credentials
  ##
  imagePullSecret: null

  ## Node selector constraints for pod scheduling
  ##
  nodeSelector: {}
    # Add node selectors here as needed
    # kubernetes.io/arch: amd64
    # node-type: cpu
    # zone: us-west-2a

  ## Service account name for the OSMO services
  ##
  serviceAccountName: osmo

  ## Logging configuration for all Osmo services
  ##
  logs:
    ## Enable centralized logging collection and log volume mounting
    ##
    enabled: true

    ## Application log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
    ##
    logLevel: DEBUG

    ## Kubernetes system log level (DEBUG, INFO, WARNING, ERROR, CRITICAL)
    ##
    k8sLogLevel: WARNING

## Service account configuration for core Osmo services
##
serviceAccount:
  ## Create the chart-managed ServiceAccount. Set to false to re-use
  ## an existing ServiceAccount that already has workload identity bindings.
  ##
  create: true

  ## ServiceAccount name override. When empty, uses global.serviceAccountName.
  ##
  name: ""

  ## Extra ServiceAccount annotations such as
  ## `azure.workload.identity/client-id` for AKS workload identity.
  ##
  annotations: {}

## Configuration for individual Osmo services
##
services:
  ## Configuration file service settings
  ##
  configFile:
    ## Enable external configuration file loading
    ##
    enabled: false

    ## Path to the configuration file (used when enabled is true)
    ##
    path: /opt/osmo/config.yaml

  ## PostgreSQL database service configuration
  ## Set enabled to false if using an external PostgreSQL deployment
  ##
  postgres:
    ## Enable PostgreSQL deployment on Kubernetes
    ## Set to false if using external PostgreSQL or managed service
    ##
    enabled: false

    ## PostgreSQL Docker image to use
    ##
    image: "postgres:15.1"

    ## Kubernetes image pull policy for PostgreSQL
    ##
    imagePullPolicy: Always

    ## Kubernetes service name for PostgreSQL
    ##
    serviceName: postgres

    ## PostgreSQL service port
    ##
    port: 5432

    ## Database name to create and use
    ##
    db: osmo

    ## Enable NodePort service for external access
    ##
    enableNodePort: true

    ## NodePort number for external access (when enableNodePort is true)
    ##
    nodePort: 30033

    ## Persistent volume size for PostgreSQL data
    ##
    storageSize: 20Gi

    ## Storage class name for persistent volume
    ## Leave empty to use default storage class
    ##
    storageClassName: ""

    ## Node selector constraints for PostgreSQL pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux
    # node-type: database

    ## Tolerations for PostgreSQL pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "dedicated"
    #   operator: "Equal"
    #   value: "database"
    #   effect: "NoSchedule"

    ## PostgreSQL username
    ##
    user: postgres

    ## PostgreSQL password secret configuration
    ## Name of the Kubernetes secret containing the PostgreSQL password
    ##
    passwordSecretName: postgres-secret

    ## Key name in the secret that contains the PostgreSQL password
    ##
    passwordSecretKey: password

  ## Redis cache service configuration
  ## Set enabled to false if using an external Redis deployment
  ##
  redis:
    ## Enable Redis deployment on Kubernetes
    ## Set to false if using external Redis or managed service
    ##
    enabled: false

    ## Redis Docker image to use
    ##
    image: "redis:7.0"

    ## Kubernetes image pull policy for Redis
    ##
    imagePullPolicy: Always

    ## Kubernetes service name for Redis
    ##
    serviceName: redis

    ## Redis service port
    ##
    port: 6379

    ## Redis database number to use (0-15)
    ##
    dbNumber: 0

    ## Enable NodePort service for external access
    ##
    enableNodePort: true

    ## NodePort number for external access (when enableNodePort is true)
    ##
    nodePort: 30034

    ## Persistent volume size for Redis data
    ##
    storageSize: 20Gi

    ## Storage class name for persistent volume
    ## Leave empty to use default storage class
    ##
    storageClassName: ""

    ## Node selector constraints for Redis pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux
    # node-type: cache

    ## Tolerations for Redis pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "dedicated"
    #   operator: "Equal"
    #   value: "cache"
    #   effect: "NoSchedule"

    ## Enable TLS encryption for Redis connections
    ##
    tlsEnabled: true

  ## Localstack S3 Object storage service configuration (local development + testing only)
  ## Set enabled to false if using an external Object storage deployment
  ##
  localstackS3:
    ## Enable Localstack S3 Object storage deployment on Kubernetes
    ## Set to false if using external Localstack S3 Object storage or managed service
    ##
    enabled: false

    ## Localstack S3 Object storage Docker image to use
    ##
    image: "gresau/localstack-persist:latest"

    ## Kubernetes image pull policy for Localstack S3 Object storage
    ##
    imagePullPolicy: Always

    ## Localstack S3 Object storage service name
    ##
    serviceName: localstack-s3

    ## Localstack S3 service port
    ##
    port: 4566

    ## Enable NodePort service for external access
    ##
    enableNodePort: true

    ## NodePort number for external access (when enableNodePort is true)
    ##
    nodePort: 30035

    ## Region for the Localstack S3 Object storage
    ##
    region: us-east-1

    ## Access key for the Localstack S3 Object storage
    ##
    accessKeyId: test

    ## Secret key for the Localstack S3 Object storage
    ##
    accessKey: test

    ## Buckets for the Localstack S3 Object storage
    ##
    buckets: []

    ## Image for the Localstack S3 Object storage bucket initialization
    ##
    bucketInitImage: amazon/aws-cli:2.15.33

    ## Persistent volume configuration for Localstack S3 Object storage
    ##
    persistence:
      enabled: true
      size: 5Gi
      storageClassName: standard

    ## Resource limits and requests for the Localstack S3 Object storage container
    ##
    resources: {}

  ## Delayed job monitor service configuration
  ##
  delayedJobMonitor:
    ## Number of delayed job monitor replicas to run
    ##
    replicas: 1

    ## Docker image name for the delayed job monitor service
    ##
    imageName: delayed-job-monitor

    ## Kubernetes image pull policy for the delayed job monitor service
    ##
    imagePullPolicy: Always

    ## Kubernetes service name for the delayed job monitor service
    ##
    serviceName: osmo-delayed-job-monitor

    ## Init containers for delayed job monitor
    ##
    initContainers: []

    ## Node selector constraints for delayed job monitor pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux
    # node-type: cpu

    ## Volumes for delayed job monitor
    ## Default includes progress files for liveness and startup probes
    ##
    volumes:
      - name: progress-files
        emptyDir: {}

    ## Volume mounts for delayed job monitor
    ## Default includes progress files for liveness and startup probes
    ##
    volumeMounts:
      - name: progress-files
        mountPath: /var/run/osmo

    ## Resource limits and requests for the delayed job monitor container
    ##
    resources: {}
    # limits:
    #   cpu: 200m
    #   memory: 256Mi
    # requests:
    #   cpu: 100m
    #   memory: 128Mi

    ## Tolerations for delayed job monitor pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "node-type"
    #   operator: "Equal"
    #   value: "cpu"
    #   effect: "NoSchedule"

    ## Extra pod annotations for the delayed job monitor service
    ##
    extraPodAnnotations: {}

    ## Extra pod labels for the delayed job monitor service pods.
    ## Use for workload identity labels like `azure.workload.identity/use`.
    ##
    extraPodLabels: {}

    ## Extra environment variables for the delayed job monitor service container
    ##
    extraEnv: []

    ## Extra command line arguments for the delayed job monitor service
    ##
    extraArgs: []

    ## Extra volume mounts for the delayed job monitor service container
    ##
    extraVolumeMounts: []

    ## Extra volumes for the delayed job monitor service pod
    ##
    extraVolumes: []

    ## Extra sidecar containers for the delayed job monitor service pod
    ##
    extraSidecars: []

    ## Service account name for the delayed job monitor service
    ##
    serviceAccountName: ""

  ## Worker service configuration for background job processing
  ##
  worker:
    ## Horizontal Pod Autoscaler (HPA) configuration for workers
    ##
    scaling:
      ## Minimum number of worker replicas
      ##
      minReplicas: 2

      ## Maximum number of worker replicas when scaling
      ##
      maxReplicas: 10

      ## Target Memory utilization percentage for HPA scaling
      ##
      hpaMemoryTarget: 80
      ## Target CPU utilization percentage for HPA scaling
      ##
      hpaCpuTarget: 80

    ## Docker image name for the worker service
    ##
    imageName: worker

    ## Kubernetes image pull policy for the worker service
    ##
    imagePullPolicy: Always

    ## Kubernetes service name for the worker service
    ##
    serviceName: osmo-worker

    ## Init containers for worker
    ##
    initContainers: []

    ## Node selector constraints for worker pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux
    # node-type: cpu


    ## Topology spread constraints to distribute worker pods across nodes/zones
    ##
    topologySpreadConstraints:
    ## Spread worker pods across different hostnames (nodes)
    ##
    - topologyKey: kubernetes.io/hostname
      maxSkew: 1
      whenUnsatisfiable: ScheduleAnyway
    ## Spread worker pods across different availability zones
    ##
    - topologyKey: topology.kubernetes.io/zone
      maxSkew: 1
      whenUnsatisfiable: ScheduleAnyway

    ## Resource limits and requests for the worker container
    ##
    resources: {}
    # limits:
    #   cpu: 1000m
    #   memory: 1Gi
    # requests:
    #   cpu: 500m
    #   memory: 512Mi

    ## Tolerations for worker pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "node-type"
    #   operator: "Equal"
    #   value: "cpu"
    #   effect: "NoSchedule"

    ## Extra pod annotations for the worker service
    ##
    extraPodAnnotations: {}

    ## Extra pod labels for the worker service pods.
    ## Use for workload identity labels like `azure.workload.identity/use`.
    ##
    extraPodLabels: {}

    ## Extra environment variables for the worker service container
    ##
    extraEnv: []

    ## Additional command line arguments to pass to the worker service
    ##
    extraArgs: []
    # - "--concurrency=10"
    # - "--max-memory=1Gi"

    ## Extra volume mounts for the worker service container
    ##
    extraVolumeMounts: []

    ## Extra volumes for the worker service pod
    ##
    extraVolumes: []

    ## Extra sidecar containers for the worker service pod
    ##
    extraSidecars: []

    ## Service account name for the worker service
    ##
    serviceAccountName: ""

  ## Main API service configuration
  ##
  service:
    ## Horizontal Pod Autoscaler (HPA) configuration for the API service
    ##
    scaling:
      ## Minimum number of API service replicas
      ##
      minReplicas: 3

      ## Maximum number of API service replicas when scaling
      ##
      maxReplicas: 9

      ## Target CPU utilization percentage for HPA scaling
      ##
      hpaMemoryTarget: 80
      ## Target CPU utilization percentage for HPA scaling
      ##
      hpaCpuTarget: 80

    ## Docker image name for the API service
    ##
    imageName: service

    ## Kubernetes image pull policy for the API service
    ##
    imagePullPolicy: Always

    ## Kubernetes service name for the API service
    ##
    serviceName: osmo-service

    ## Init containers for API service
    ##
    initContainers: []

    ## Hostname on which the ingress is served
    ## Leave empty to use the default cluster hostname
    ##
    hostname: ""

    ## Host aliases for custom DNS resolution within the API service pods
    ##
    hostAliases: []
    # - ip: "192.168.1.100"
    #   hostnames:
    #   - "example.local"

    ## Disable task metrics collection (set to true to disable)
    ##
    disableTaskMetrics: false

    ## Enable authentication for the API service
    ## An example when using Keycloak is:
    ##
    ## auth:
    ##   enabled: true
    ##   device_endpoint: https://auth-name.osmo.nvidia.com/realms/osmo/protocol/openid-connect/auth
    ##   device_client_id: osmo-device
    ##   browser_endpoint: https://auth-name.osmo.nvidia.com/realms/osmo/protocol/openid-connect/auth
    ##   browser_client_id: osmo-browser-flow
    ##   token_endpoint: https://auth-name.osmo.nvidia.com/realms/osmo/protocol/openid-connect/token
    ##   logout_endpoint: https://auth-name.osmo.nvidia.com/realms/osmo/protocol/openid-connect/logout
    ##
    ## An example when using Microsoft Azure AD is:
    ##
    ## auth:
    ##   enabled: true
    ##   device_endpoint: https://login.microsoftonline.com/<id>/oauth2/v2.0/devicecode
    ##   device_client_id: <client-id>
    ##   browser_endpoint: https://login.microsoftonline.com/<id>/oauth2/v2.0/authorize
    ##   browser_client_id: <client-id>
    ##   token_endpoint: https://login.microsoftonline.com/<id>/oauth2/v2.0/token
    ##   logout_endpoint: https://login.microsoftonline.com/<id>/oauth2/v2.0/logout
    ##
    auth:
      enabled: false

      ## URL for the device endpoint
      ##
      device_endpoint: ""

      ## Client ID for the device endpoint
      ##
      device_client_id: ""

      ## URL for the browser endpoint
      ##
      browser_endpoint: ""

      ## Client ID for the browser endpoint
      ##
      browser_client_id: ""

      ## URL for the token endpoint
      ##
      token_endpoint: ""

      ## URL for the logout endpoint
      ##
      logout_endpoint: ""

    ## Ingress configuration for external access to the API service
    ##
    ingress:
      ## Enable ingress for external access
      ##
      enabled: true

      ## URL path prefix for all ingress rules
      ##
      prefix: /

      ## Ingress controller class to use for routing traffic
      ##
      ingressClass: nginx

      ## AWS Application Load Balancer (ALB) specific annotations
      ##
      albAnnotations:
        ## Enable ALB-specific annotations in the ingress
        ##
        enabled: false

        ## ARN of the SSL certificate for HTTPS traffic
        ##
        sslCertArn: arn:aws:acm:us-west-2:XXXXXXXXX:certificate/YYYYYYYY

      ## Enable SSL/TLS encryption for the ingress
      ##
      sslEnabled: true

      ## Name of the Kubernetes secret containing SSL/TLS certificates
      ##
      sslSecret: osmo-tls

      ## Additional custom annotations for the ingress resource
      ##
      annotations: {}
      # nginx.ingress.kubernetes.io/proxy-body-size: "100m"
      # alb.ingress.kubernetes.io/target-type: ip

    ## Liveness probe configuration for the API service
    ##
    livenessProbe:
      ## HTTP GET probe configuration
      ##
      httpGet:
        port: 8000
        path: /api/version
      ## Timeout for the probe
      ##
      timeoutSeconds: 20
      ## Number of failures before marking as unhealthy
      ##
      failureThreshold: 3
      ## How often to perform the probe
      ##
      periodSeconds: 45

    ## Node selector constraints for API service pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux
    # node-type: cpu

    ## Topology spread constraints to distribute API service pods across zones
    ##
    topologySpreadConstraints:
    ## Spread API service pods across different availability zones
    ##
    - topologyKey: topology.kubernetes.io/zone
      maxSkew: 1
      whenUnsatisfiable: ScheduleAnyway

    ## Resource limits and requests for the API service container
    ##
    resources: {}
    # limits:
    #   cpu: 2000m
    #   memory: 2Gi
    # requests:
    #   cpu: 1000m
    #   memory: 1Gi

    ## Tolerations for API service pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "node-type"
    #   operator: "Equal"
    #   value: "cpu"
    #   effect: "NoSchedule"

    ## Extra pod annotations for the API service
    ##
    extraPodAnnotations: {}

    ## Extra pod labels for the API service pods.
    ## Use for workload identity labels like `azure.workload.identity/use`.
    ##
    extraPodLabels: {}

    ## Extra environment variables for the API service container
    ##
    extraEnv: []

    ## Additional command line arguments to pass to the API service
    ##
    extraArgs: []
    # - "--debug"
    # - "--max-connections=1000"

    ## Extra volume mounts for the API service container
    ##
    extraVolumeMounts: []

    ## Extra volumes for the API service pod
    ##
    extraVolumes: []

    ## Extra sidecar containers for the API service pod
    ##
    extraSidecars: []

    ## Service account name for the API service
    ##
    serviceAccountName: ""

    ## Per-service Envoy proxy configuration overrides
    ## These settings override the global sidecars.envoy configuration for this service only
    ## Any field from sidecars.envoy can be specified here to override the global default
    ##
    envoy: {}
    # maxRequests: 200
    # routes: [...]
    # skipAuthPaths: [...]

  ## Logger service configuration for log collection and processing
  ##
  logger:
    ## Horizontal Pod Autoscaler (HPA) configuration for the logger service
    ##
    scaling:
      ## Minimum number of logger service replicas
      ##
      minReplicas: 3

      ## Maximum number of logger service replicas when scaling
      ##
      maxReplicas: 9

      ## Target Memory utilization percentage for HPA scaling
      ##
      hpaMemoryTarget: 80
      ## Target CPU utilization percentage for HPA scaling
      ##
      hpaCpuTarget: 80

    ## Docker image name for the logger service
    ##
    imageName: logger

    ## Kubernetes image pull policy for the logger service
    ##
    imagePullPolicy: Always

    ## Kubernetes service name for the logger service
    ##
    serviceName: osmo-logger

    ## Init containers for logger service
    ##
    initContainers: []

    ## Node selector constraints for logger service pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux
    # node-type: cpu

    ## Topology spread constraints to distribute logger service pods across zones
    ##
    topologySpreadConstraints:
    ## Spread logger service pods across different availability zones
    ##
    - topologyKey: topology.kubernetes.io/zone
      maxSkew: 1
      whenUnsatisfiable: ScheduleAnyway

    ## Resource limits and requests for the logger service container
    ##
    resources:
      ## Resource requests (guaranteed allocation)
      ##
      requests:
        cpu: "1"
        memory: "1Gi"
      ## Resource limits (maximum allocation)
      ##
      limits:
        memory: "1Gi"

    ## Tolerations for logger service pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "node-type"
    #   operator: "Equal"
    #   value: "cpu"
    #   effect: "NoSchedule"

    ## Extra pod annotations for the logger service
    ##
    extraPodAnnotations: {}

    ## Extra pod labels for the logger service pods.
    ## Use for workload identity labels like `azure.workload.identity/use`.
    ##
    extraPodLabels: {}

    ## Extra environment variables for the logger service container
    ##
    extraEnv: []

    ## Extra command line arguments for the logger service
    ##
    extraArgs: []

    ## Extra volume mounts for the logger service container
    ##
    extraVolumeMounts: []

    ## Extra volumes for the logger service pod
    ##
    extraVolumes: []

    ## Extra sidecar containers for the logger service pod
    ##
    extraSidecars: []

    ## Service account name for the logger service
    ##
    serviceAccountName: ""

    ## Per-service Envoy proxy configuration overrides
    ## These settings override the global sidecars.envoy configuration for this service only
    ## Any field from sidecars.envoy can be specified here to override the global default
    ##
    envoy: {}
    # maxRequests: 50
    # routes: [...]

  ## Agent service configuration for client communication and management
  ##
  agent:
    ## Horizontal Pod Autoscaler (HPA) configuration for the agent service
    ##
    scaling:
      ## Minimum number of agent service replicas
      ##
      minReplicas: 1

      ## Maximum number of agent service replicas when scaling
      ##
      maxReplicas: 9

      ## Target CPU utilization percentage for HPA scaling
      ##
      hpaMemoryTarget: 80
      ## Target CPU utilization percentage for HPA scaling
      ##
      hpaCpuTarget: 80

    ## Docker image name for the agent service
    ##
    imageName: agent

    ## Kubernetes image pull policy for the agent service
    ##
    imagePullPolicy: Always

    ## Kubernetes service name for the agent service
    ##
    serviceName: osmo-agent

    ## Init containers for agent service
    ##
    initContainers: []

    ## Node selector constraints for agent service pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux
    # node-type: cpu

    ## Topology spread constraints to distribute agent service pods across zones
    ##
    topologySpreadConstraints:
    ## Spread agent service pods across different availability zones
    ##
    - topologyKey: topology.kubernetes.io/zone
      maxSkew: 1
      whenUnsatisfiable: ScheduleAnyway

    ## Resource limits and requests for the agent service container
    ##
    resources:
      ## Resource requests (guaranteed allocation)
      ##
      requests:
        cpu: "500m"
        memory: "500Mi"
      ## Resource limits (maximum allocation)
      ##
      limits:
        memory: "500Mi"

    ## Tolerations for agent service pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "node-type"
    #   operator: "Equal"
    #   value: "cpu"
    #   effect: "NoSchedule"

    ## Extra pod annotations for the agent service
    ##
    extraPodAnnotations: {}

    ## Extra pod labels for the agent service pods.
    ## Use for workload identity labels like `azure.workload.identity/use`.
    ##
    extraPodLabels: {}

    ## Extra environment variables for the agent service container
    ##
    extraEnv: []

    ## Extra command line arguments for the agent service
    ##
    extraArgs: []

    ## Extra volume mounts for the agent service container
    ##
    extraVolumeMounts: []

    ## Extra volumes for the agent service pod
    ##
    extraVolumes: []

    ## Extra sidecar containers for the agent service pod
    ##
    extraSidecars: []

    ## Service account name for the agent service
    ##
    serviceAccountName: ""

    ## Per-service Envoy proxy configuration overrides
    ## These settings override the global sidecars.envoy configuration for this service only
    ## Any field from sidecars.envoy can be specified here to override the global default
    ##
    envoy: {}
    # maxRequests: 100
    # routes: [...]

## Configuration for service sidecar containers
##
sidecars:

  ## Global Envoy proxy configuration shared across all services
  ## Applied to: osmo-service, osmo-logger, osmo-agent
  ## To override these settings per-service, use services.<service>.envoy
  ## Example: services.service.envoy.maxRequests to override maxRequests for API service only
  ##
  envoy:
    ## List of IP addresses to block
    ##
    blockedIPs: []

    ## Enable Envoy proxy sidecar container
    ##
    enabled: true

    ## Use Kubernetes secret for credentials
    ##
    useKubernetesSecrets: false

    livenessProbe:
      httpGet:
        path: /ready
        port: 9901
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 3

    readinessProbe:
      httpGet:
        path: /ready
        port: 9901
      initialDelaySeconds: 5
      periodSeconds: 5
      timeoutSeconds: 3

    startupProbe:
      httpGet:
        path: /ready
        port: 9901
      initialDelaySeconds: 15
      periodSeconds: 5
      timeoutSeconds: 3

    ## Secret paths for OAuth2 credentials
    ##
    secretPaths:
      clientSecret: /etc/envoy/secrets/client_secret
      hmacSecret: /etc/envoy/secrets/hmac_secret
    ## Paths that are allowed to be accessed without authentication in the cluster
    ##
    inClusterPaths:
      ## Enable in-cluster routing for specific paths
      ##
      enabled: false

      ## Port for in-cluster communication
      ##
      port: 8081

      ## List of paths that are allowed to be accessed without authentication in the cluster
      ##
      paths:
      - /api/resources
      - /api/configs/pool
      - /api/bucket/list_dataset
      - /api/workflow
      - /api/router/version
      - /api/task

    ## Maximum number of concurrent requests Envoy will handle
    ##
    maxRequests: 100

    ## Default service name for Envoy configuration
    ##
    serviceName: osmo

    ## List of paths that are allowed to be accessed without authentication to the public
    ##
    skipAuthPaths:
    - /api/version
    - /api/auth/login
    - /api/auth/keys
    - /api/auth/refresh_token
    - /api/auth/jwt/refresh_token
    - /api/auth/jwt/access_token
    - /client/version

    ## Advanced routing configuration for Envoy proxy
    ## Contains detailed regex-based routing rules for various API endpoints
    ## including workflow logs, agent backends, pool management, data operations,
    ## and client downloads. Each route specifies clusters, timeouts, and
    ## rate limiting configurations as needed.
    ##
    routes:
    - match:
        safe_regex:
          regex: "/api/workflow/[^/]+/logs"
      route:
        cluster: service
        timeout: 0s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "workflow_artifact_path_limit"
        - actions:
          - generic_key:
              descriptor_key: workflow_artifact
              descriptor_value: workflow_artifact_limit
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: OSMO_USER
    - match:
        safe_regex:
          regex: "/api/agent/worker/backend/[^/]+"
      route:
        cluster: service
        timeout: 0s
    - match:
        safe_regex:
          regex: "/api/agent/listener/[^/]+/backend/[^/]+"
      route:
        cluster: service
        timeout: 0s
    - match:
        safe_regex:
          regex: "^/api/pool(/.*)?$"
      route:
        cluster: service
        timeout: 60s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "pool_path_limit"
        - actions:
          - generic_key:
              descriptor_key: pool
              descriptor_value: pool_limit
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: OSMO_USER
    - match:
        safe_regex:
          regex: "^/api/bucket(/.*)?$"
      route:
        cluster: service
        timeout: 60s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "PATH"
        - actions:
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
    - match:
        safe_regex:
          regex: "/api/workflow/[^/]+/spec"
      route:
        cluster: service
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "workflow_artifact_path_limit"
        - actions:
          - generic_key:
              descriptor_key: workflow_artifact
              descriptor_value: workflow_artifact_limit
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: OSMO_USER
    - match:
        safe_regex:
          regex: "^/api/workflow(/.*)?$"
      route:
        cluster: service
        timeout: 60s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "workflow_artifact_path_limit"
        - actions:
          - generic_key:
              descriptor_key: workflow
              descriptor_value: workflow_limit
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
    - match:
        safe_regex:
          regex: "^/api/task(/.*)?$"
      route:
        cluster: service
        timeout: 60s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "task_path_limit"
        - actions:
          - generic_key:
              descriptor_key: task
              descriptor_value: task_limit
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
    - match:
        safe_regex:
          regex: "^/api/resources(/.*)?$"
      route:
        cluster: service
        timeout: 60s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "resource_path_limit"
        - actions:
          - generic_key:
              descriptor_key: resource
              descriptor_value: resource_limit
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
    - match:
        prefix: "/client"
      route:
        cluster: service
        timeout: 0s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "client_path_limit"
        - actions:
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
    - match:
        prefix: "/api/configs"
      route:
        cluster: service
        timeout: 60s
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "PATH"
        - actions:
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
    - match:
        prefix: /api/auth/jwt/refresh_token
      route:
        cluster: service
        rate_limits:
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "refresh_token_path_limit"
    - match:
        prefix: /api/version
      route:
        cluster: service
        rate_limits:
        - actions:
          - generic_key:
              descriptor_key: version_path
              descriptor_value: version_path_user_limit
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "version_path_limit"
    - match:
        prefix: "/"
      route:
        cluster: service
        rate_limits:
        - actions:
          - request_headers:
              header_name: X-OSMO-USER
              descriptor_key: "OSMO_USER"
        - actions:
          - request_headers:
              header_name: ":path"
              descriptor_key: "PATH"

    ## Envoy proxy container image
    ##
    image: "envoyproxy/envoy:v1.29.0"

    ## Init container image for setup tasks
    ##
    initImage: busybox

    ## Image pull policy for Envoy containers
    ##
    imagePullPolicy: IfNotPresent

    ## Security context for Envoy containers
    ##
    securityContext:
      allowPrivilegeEscalation: false
      capabilities:
        drop: ["ALL"]
      runAsNonRoot: true
      runAsUser: 1001


    ## Volume mounts for Envoy containers
    ##
    extraVolumeMounts: []

    ## Listener port for Envoy proxy
    ##
    listenerPort: 8080

    ## Maximum size of all http headers in kb
    ##
    maxHeadersSizeKb: 128

    ## Log level for Envoy proxy
    ##
    logLevel: info

    ## Resource limits and requests for Envoy containers
    ##
    resources:
      requests:
        cpu: "100m"
        memory: "64Mi"
      limits:
        memory: "128Mi"

    ## SSL/TLS configuration
    ##
    ssl:
      enabled: false
      cert:
        secretName: envoy-ssl-cert
        secretKey: cert
      privateKey:
        secretName: envoy-ssl-cert
        secretKey: privateKey

    ## Service configuration for Envoy proxy
    ##
    service:
      ## Port on which Envoy proxy listens
      ##
      port: 8000

      ## Hostname for the Envoy service (leave empty for default)
      ##
      hostname: ""

      ## Address for the main service backend
      ##
      address: 127.0.0.1

    ## OAuth2 authentication filter configuration
    ##
    oauth2Filter:
      ## Enable OAuth2 authentication filter
      ##
      enabled: true

      ## OAuth2 token endpoint URL for token exchange
      ##
      tokenEndpoint: ""

      ## OAuth2 authorization endpoint URL for login redirect
      ##
      authEndpoint: ""

      ## Redirect path after successful authentication
      ##
      redirectPath: api/auth/getAToken

      ## OAuth2 client ID for this application
      ##
      clientId: ""

      ## OAuth2 authentication provider name
      ##
      authProvider: ""

      ## Path for user logout functionality
      ##
      logoutPath: logout

      ## Forward bearer token to upstream service
      ##
      forwardBearerToken: true

      ## Kubernetes secret keys (when useKubernetesSecrets is true)
      ##
      secretName: oidc-secrets
      clientSecretKey: client_secret
      hmacSecretKey: hmac_secret

    ## JWT (JSON Web Token) authentication configuration
    ##
    jwt:
      ## HTTP header name that contains the user information
      ##
      user_header: x-osmo-user

      ## List of JWT providers for token validation
      ##
      ## An example when using Keycloak is:
      ##
      ## providers:
      ## - issuer: https://auth-name.osmo.nvidia.com/realms/osmo
      ##   audience: osmo-device
      ##   jwks_uri: https://auth-name.osmo.nvidia.com/realms/osmo/protocol/openid-connect/certs
      ##   user_claim: preferred_username
      ##   cluster: oauth
      ##
      ## An example when using Microsoft Azure AD is:
      ##
      ## providers:
      ## - issuer: https://sts.windows.net/<id>/
      ##   audience: <client-id>
      ##   jwks_uri: https://login.microsoftonline.com/<id>/discovery/v2.0/keys
      ##   user_claim: unique_name
      ##   cluster: oauth
      providers:
      ## External OAuth provider configuration (provider 1)
      ##
      ## An example when using Keycloak is:
      ##
      ## - issuer: https://auth-name.osmo.nvidia.com/realms/osmo
      ##   audience: osmo-browser-flow
      ##   jwks_uri: https://auth-name.osmo.nvidia.com/realms/osmo/protocol/openid-connect/certs
      ##   user_claim: preferred_username
      ##   cluster: oauth
      ##
      ## An example when using Microsoft Azure AD is:
      ##
      ## - issuer: https://login.microsoftonline.com/<id>/v2.0
      ##   audience: <client-id>
      ##   jwks_uri: https://login.microsoftonline.com/<id>/discovery/v2.0/keys
      ##   user_claim: preferred_username
      ##   cluster: oauth
      - issuer: ""
        audience: ""
        jwks_uri: ""
        user_claim: unique_name
        cluster: oauth
      ## External OAuth provider configuration (provider 2)
      ##
      ## An example when using Keycloak is:
      ##
      ## - issuer: https://auth-name.osmo.nvidia.com/realms/osmo
      ##   audience: osmo-device
      ##   jwks_uri: https://auth-name.osmo.nvidia.com/realms/osmo/protocol/openid-connect/certs
      ##   user_claim: preferred_username
      ##   cluster: oauth
      ##
      ## An example when using Microsoft Azure AD is:
      ##
      ## - issuer: https://login.microsoftonline.com/<id>/v2.0
      ##   audience: <client-id>
      ##   jwks_uri: https://login.microsoftonline.com/<id>/discovery/v2.0/keys
      ##   user_claim: preferred_username
      ##   cluster: oauth
      - issuer: ""
        audience: ""
        jwks_uri: ""
        user_claim: preferred_username
        cluster: oauth
      ## Internal Osmo JWT provider configuration
      ##
      ## An example when using Keycloak is:
      ##
      ## - issuer: osmo
      ##   audience: osmo
      ##   jwks_uri: http://osmo-service/api/auth/keys
      ##   user_claim: unique_name
      ##   cluster: service
      ##
      ## An example when using Microsoft Azure AD is:
      ##
      ## - issuer: osmo
      ##   audience: osmo
      ##   jwks_uri: http://osmo-service/api/auth/keys
      ##   user_claim: unique_name
      ##   cluster: service
      - issuer: osmo
        audience: osmo
        jwks_uri: http://localhost:8000/api/auth/keys
        user_claim: unique_name
        cluster: service



  ## Log agent configuration for centralized log collection
  ##
  logAgent:
    ## Enable log agent sidecar
    ##
    enabled: true

    ## Log agent container image
    ##
    image: fluent/fluent-bit:4.0.8-debug

    ## Image pull policy for log agent containers
    ##
    imagePullPolicy: IfNotPresent

    ## Prometheus metrics port
    ##
    prometheusPort: 2020

    ## Log rotation configuration
    ##
    logrotate:
      ## Enable automatic log rotation
      ##
      enabled: true

      ## Log rotation frequency
      ##
      frequency: hourly

      ## Maximum log file size before rotation
      ##
      maxSize: 10M

      ## Number of rotated files to keep
      ##
      rotateCount: 5

      ## Sleep interval between rotation checks (seconds)
      ##
      sleepSeconds: 60

    ## ConfigMap name for log agent configuration
    ##
    configName: osmo-log-agent-config


    ## CloudWatch logging configuration
    ##
    cloudwatch:
      enabled: false
      region: us-west-2
      clusterName: ""

    ## Resource limits and requests for log agent containers
    ##
    resources:
      requests:
        cpu: "250m"
        memory: "400Mi"
      limits:
        memory: "400Mi"

    ## Extra volume mounts for log agent
    ##
    extraVolumeMounts: []

    ## Extra volumes for log agent
    ##
    volumes: []

  ## OpenTelemetry (OTEL) configuration for observability
  ##
  otel:
    ## Enable OTEL collector sidecar for metrics and tracing
    ##
    enabled: true

    ## OTEL collector container image
    ##
    image: otel/opentelemetry-collector-contrib:0.68.0

    ## ConfigMap name for OTEL collector configuration
    ##
    configName: otel-config

    ## Resource limits and requests for OTEL containers
    ##
    resources:
      requests:
        cpu: "100m"
        memory: "128Mi"
      limits:
        memory: "128Mi"

    ## Ports for OTEL collector
    ##
    ports:
      - containerPort: 4000
        name: metrics

  ## Rate limiting service configuration
  ##
  rateLimit:
    ## Enable rate limiting service
    ##
    enabled: true

    ## Rate limiting service image
    ##
    image: envoyproxy/ratelimit:9d8d70a8 # 2022/08/16

    ## Image pull policy for rate limiting service
    ##
    imagePullPolicy: IfNotPresent

    ## Redis configuration for rate limit storage
    ##
    redis:
      ## Redis service name for rate limit data storage
      ##
      serviceName: ""

      ## Redis port for rate limit data storage
      ##
      port: 6379

    ## ConfigMap name for rate limiting configuration
    ##
    configName: ratelimit-config

    ## Service name for rate limiting service
    ##
    serviceName: ratelimit

    ## Node selector constraints for rate limiting pod scheduling
    ##
    nodeSelector: {}
    # kubernetes.io/os: linux

    ## Tolerations for rate limiting pod scheduling on tainted nodes
    ##
    tolerations: []
    # - key: "dedicated"
    #   operator: "Equal"
    #   value: "ratelimit"
    #   effect: "NoSchedule"

    ## Resource limits and requests for rate limiting service
    ##
    resources:
      ## Resource requests (guaranteed allocation)
      ##
      requests:
        cpu: "0.1"
        memory: "200Mi"
      ## Resource limits (maximum allocation)
      ##
      limits:
        memory: "200Mi"

    ## HTTP port for rate limiting service
    ##
    httpPort: 8090

    ## gRPC port for rate limiting service
    ##
    grpcPort: 8091

    ## Debug port for rate limiting service
    ##
    debugPort: 6070

## Global configuration for extra ConfigMaps
## These ConfigMaps can be used for custom configurations
##
extraConfigMaps: []
# - name: custom-config
#   data:
#     config.yaml: |
#       key: value
