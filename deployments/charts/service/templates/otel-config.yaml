# SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0
{{- if .Values.sidecars.otel.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: otel-config
data:
  collector.yaml: |
    receivers:
      otlp/spanmetrics:
        protocols:
          grpc:
            endpoint: "localhost:12345"
      prometheus/envoy:
        config:
          scrape_configs:
          - job_name: otel-envoy-eg
            scrape_interval: 5s
            metrics_path: /stats/prometheus
            static_configs:
            - targets: ["localhost:9901"]

    processors:
      memory_limiter:
        check_interval: 5s
        limit_mib: 30
      batch:
        send_batch_size: 100

    exporters:
      logging:
      prometheus:
        enable_open_metrics: true
        endpoint: "0.0.0.0:4000"
        resource_to_telemetry_conversion:
          enabled: true

    service:
      pipelines:
        metrics:
          receivers: [otlp/spanmetrics, prometheus/envoy]
          processors: [memory_limiter, batch]
          exporters: [prometheus]
{{- end }}
